<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Eureka</title>
    <meta name="color-scheme" content="light dark" />
    <style>
      :root {
        --bg: #0f172a;
        --panel: #111827;
        --text: #e5e7eb;
        --muted: #9ca3af;
        --primary: #22c55e;
        --primary-600: #16a34a;
        --danger: #ef4444;
        --warning: #f59e0b;
        --link: #60a5fa;
        --border: #1f2937;
      }
      html, body { height: 100%; }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        background: linear-gradient(180deg, #0b1020, #0f172a 30%);
        color: var(--text);
      }
      .container {
        max-width: 920px;
        margin: 0 auto;
        padding: 24px;
      }
      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        padding: 16px 0 8px;
        border-bottom: 1px solid var(--border);
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .logo {
        width: 36px; height: 36px;
        border-radius: 8px;
        background: radial-gradient(100% 100% at 0% 0%, #22c55e 0%, #1d4ed8 100%);
        box-shadow: 0 6px 24px rgba(34, 197, 94, 0.25);
      }
      h1 { font-size: 22px; margin: 0; letter-spacing: 0.4px; }
      .userbox { font-size: 14px; color: var(--muted); display: flex; gap: 8px; align-items: center; }
      .btn {
        background: var(--primary);
        color: #061313;
        border: none;
        padding: 10px 14px;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.06s ease, background 0.2s ease;
      }
      .btn:hover { background: var(--primary-600); }
      .btn:active { transform: translateY(1px); }
      .btn.secondary { background: transparent; color: var(--text); border: 1px solid var(--border); }
      .btn.link { background: transparent; color: var(--link); padding: 0; border: none; }

      .grid {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 16px;
        margin-top: 20px;
      }
      .panel {
        grid-column: 1 / -1;
        background: rgba(17, 24, 39, 0.7);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 18px;
        backdrop-filter: blur(6px);
      }
      @media (min-width: 860px) {
        .panel.auth { grid-column: span 5; }
        .panel.game { grid-column: span 7; }
      }

      .tabs { display: flex; gap: 10px; margin-bottom: 14px; }
      .tab { background: transparent; border: 1px solid var(--border); color: var(--text); padding: 8px 12px; border-radius: 8px; cursor: pointer; }
      .tab.active { border-color: var(--link); color: var(--link); }

      form { display: grid; gap: 10px; }
      label { font-size: 13px; color: var(--muted); }
      input {
        background: #0b1220;
        border: 1px solid var(--border);
        color: var(--text);
        padding: 10px 12px;
        border-radius: 10px;
        outline: none;
      }
      .row { display: flex; gap: 10px; align-items: center; justify-content: space-between; }
      .hint { color: var(--muted); font-size: 13px; }
      .status { font-size: 14px; margin-top: 8px; }
      .status.error { color: var(--danger); }
      .status.warn { color: var(--warning); }
      .status.ok { color: var(--primary); }

      .game-card {
        background: #0b1220;
        border: 1px dashed var(--border);
        border-radius: 12px;
        padding: 16px;
      }
      .muted { color: var(--muted); }
      .hidden { display: none !important; }
      .big-letter {
        font-size: 64px;
        font-weight: 800;
        letter-spacing: 6px;
        margin: 8px 0;
        color: #a5b4fc;
        text-shadow: 0 4px 16px rgba(99, 102, 241, 0.3);
      }
      .letter-category { display: flex; align-items: baseline; gap: 16px; flex-wrap: wrap; }
      .category { font-size: 18px; color: var(--muted); }
      .buzzers { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; margin: 12px 0; }
      .buzzer-btn { background: #ef4444; color: white; border: none; padding: 14px 12px; border-radius: 12px; font-weight: 800; cursor: pointer; box-shadow: 0 6px 20px rgba(239, 68, 68, 0.25); }
      .buzzer-btn:disabled { opacity: 0.5; cursor: not-allowed; }
      .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
      .scoreboard { margin-top: 12px; display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 8px; }
      .score-item { background: #0b1220; border: 1px solid var(--border); padding: 10px 12px; border-radius: 10px; display: flex; align-items: center; justify-content: space-between; }
      .setup { display: grid; gap: 14px; }
      .chips { display: flex; flex-wrap: wrap; gap: 8px; }
      .chip { background: #0b1220; border: 1px solid var(--border); padding: 6px 10px; border-radius: 999px; font-size: 13px; }
      .list { max-height: 160px; overflow: auto; border: 1px solid var(--border); border-radius: 10px; padding: 10px; }
    </style>
    <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>
  <body>
    <div class="container">
      <header>
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <h1>Eureka</h1>
        </div>
        <div class="userbox" id="userbox">
          <span id="user-email" class="muted">Non connecté</span>
          <button class="btn secondary hidden" id="logout-btn">Se déconnecter</button>
        </div>
      </header>

      <div class="grid">
        <section class="panel auth" id="auth-panel">
          <div class="tabs">
            <button class="tab active" id="tab-login">Connexion</button>
            <button class="tab" id="tab-register">Inscription</button>
          </div>

          <form id="login-form" autocomplete="on">
            <div>
              <label for="login-email">Email</label>
              <input id="login-email" name="email" type="email" placeholder="vous@exemple.com" required />
            </div>
            <div>
              <label for="login-password">Mot de passe</label>
              <input id="login-password" name="password" type="password" placeholder="••••••••" minlength="6" required />
            </div>
            <div class="row">
              <button type="submit" class="btn">Se connecter</button>
              <button type="button" id="forgot-btn" class="btn link">Mot de passe oublié ?</button>
            </div>
            <div id="login-status" class="status"></div>
          </form>

          <form id="register-form" class="hidden" autocomplete="on">
            <div>
              <label for="register-email">Email</label>
              <input id="register-email" name="email" type="email" placeholder="vous@exemple.com" required />
            </div>
            <div>
              <label for="register-password">Mot de passe (min. 6 caractères)</label>
              <input id="register-password" name="password" type="password" placeholder="••••••••" minlength="6" required />
            </div>
            <div class="row">
              <button type="submit" class="btn">Créer mon compte</button>
            </div>
            <div class="hint">Selon la configuration, une validation par email peut être requise.</div>
            <div id="register-status" class="status"></div>
          </form>

          <form id="forgot-form" class="hidden" autocomplete="on">
            <div>
              <label for="forgot-email">Email</label>
              <input id="forgot-email" type="email" placeholder="vous@exemple.com" required />
            </div>
            <div class="row">
              <button type="submit" class="btn">Envoyer le lien de réinitialisation</button>
              <button type="button" id="back-to-login" class="btn secondary">Retour</button>
            </div>
            <div id="forgot-status" class="status"></div>
          </form>

          <form id="reset-form" class="hidden" autocomplete="off">
            <div class="hint">Entrez un nouveau mot de passe pour finaliser la réinitialisation.</div>
            <div>
              <label for="reset-password">Nouveau mot de passe</label>
              <input id="reset-password" type="password" placeholder="••••••••" minlength="6" required />
            </div>
            <div class="row">
              <button type="submit" class="btn">Mettre à jour le mot de passe</button>
              <button type="button" id="cancel-reset" class="btn secondary">Annuler</button>
            </div>
            <div id="reset-status" class="status"></div>
          </form>
        </section>

        <section class="panel game hidden" id="game-panel">
          <h2>Zone de jeu</h2>
          <div class="game-card">
            <div id="lobby">
              <h3>Créer une partie</h3>
              <div class="row">
                <input id="game-code-input" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="Numéro de partie (ex: 1234)" />
                <button class="btn" id="create-game">Créer</button>
              </div>
              <div id="lobby-status" class="status"></div>
              <h3 style="margin-top:16px">Parties en attente</h3>
              <div id="games-list" class="list"></div>
            </div>

            <div id="room" class="hidden">
              <div class="row">
                <div>
                  <div class="muted">Code de la partie</div>
                  <div id="room-code" class="big-letter" style="font-size:32px"></div>
                </div>
                <div style="display:flex;gap:8px;align-items:center;">
                  <button class="btn" id="launch-game">Lancer la partie</button>
                  <button class="btn secondary" id="leave-game">Quitter</button>
                </div>
              </div>
              <div id="room-status" class="status"></div>
              <div class="hint">En attente du lancement par l'hôte…</div>
            </div>

            <div id="setup" class="setup">
              <div class="grid-2">
                <div>
                  <h3>Joueurs</h3>
                  <div class="row">
                    <input id="player-name-input" placeholder="Nom du joueur" />
                    <button class="btn" id="add-player">Ajouter</button>
                  </div>
                  <div id="players-list" class="list"></div>
                </div>
                <div>
                  <h3>Manches</h3>
                  <div class="row">
                    <label for="rounds-input">Nombre de manches</label>
                    <input id="rounds-input" type="number" min="1" max="50" value="10" style="max-width:120px" />
                  </div>
                  <div class="hint">Le vainqueur est celui avec le plus de points à la fin.</div>
                </div>
              </div>
              <div>
                <h3>Catégories</h3>
                <div class="row">
                  <button class="btn secondary" id="select-all-cats">Tout sélectionner</button>
                  <button class="btn secondary" id="clear-cats">Tout désélectionner</button>
                </div>
                <div id="categories-list" class="list"></div>
              </div>
              <div class="row">
                <button class="btn" id="start-game">Démarrer la partie</button>
            <div id="game-status" class="status"></div>
              </div>
            </div>

            <div id="play" class="hidden">
              <div class="row">
                <div id="round-counter" class="hint"></div>
                <button class="btn secondary" id="end-game" title="Terminer la partie">Terminer</button>
              </div>
              <div class="letter-category">
                <div id="big-letter" class="big-letter">A</div>
                <div>
                  <div class="muted">Catégorie</div>
                  <div id="current-category" class="category"></div>
                </div>
              </div>
              <div id="buzzers" class="buzzers"></div>

              <div id="response-area" class="hidden">
                <div class="hint">Au tour de <strong id="responder-name"></strong></div>
                <div class="row">
                  <input id="proposed-word" placeholder="Votre mot..." />
                  <button class="btn" id="validate-word">Proposer</button>
                  <button class="btn secondary" id="reject-word">Annuler</button>
                </div>
                <div id="round-status" class="status"></div>
                <div id="vote-area" class="row hidden">
                  <button class="btn" id="vote-accept">Valider</button>
                  <button class="btn secondary" id="vote-reject">Refuser</button>
                </div>
              </div>

              <div class="scoreboard" id="scoreboard"></div>
              <div class="row">
                <button class="btn hidden" id="next-round">Manche suivante</button>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>

    <script>
      window.addEventListener('DOMContentLoaded', () => {
        // Initialisation Supabase (vos identifiants publics)
        const SUPABASE_URL = "https://gcqkvteqjqwlbzjwmhsu.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdjcWt2dGVxanF3bGJ6andtaHN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5MTgzODQsImV4cCI6MjA3MDQ5NDM4NH0.b7E9pAH4OW3xcxwQV-nf-kTKOjLlTf3ZPocjbB3kOoE";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Elements UI
        const userEmailEl = document.getElementById("user-email");
        const logoutBtn = document.getElementById("logout-btn");
        const authPanel = document.getElementById("auth-panel");
        const gamePanel = document.getElementById("game-panel");

        // Tabs & forms
        const tabLogin = document.getElementById("tab-login");
        const tabRegister = document.getElementById("tab-register");
        const loginForm = document.getElementById("login-form");
        const registerForm = document.getElementById("register-form");
        const forgotForm = document.getElementById("forgot-form");
        const resetForm = document.getElementById("reset-form");

        // Status areas
        const loginStatus = document.getElementById("login-status");
        const registerStatus = document.getElementById("register-status");
        const forgotStatus = document.getElementById("forgot-status");
        const resetStatus = document.getElementById("reset-status");
        const gameStatus = document.getElementById("game-status");

        const forgotBtn = document.getElementById("forgot-btn");
        const backToLoginBtn = document.getElementById("back-to-login");
        const cancelResetBtn = document.getElementById("cancel-reset");

        const loginEmail = document.getElementById("login-email");
        const loginPassword = document.getElementById("login-password");
        const registerEmail = document.getElementById("register-email");
        const registerPassword = document.getElementById("register-password");
        const forgotEmail = document.getElementById("forgot-email");
        const resetPassword = document.getElementById("reset-password");

        function setActiveTab(tab) {
          const isLogin = tab === "login";
          tabLogin.classList.toggle("active", isLogin);
          tabRegister.classList.toggle("active", !isLogin);
          loginForm.classList.toggle("hidden", !isLogin);
          registerForm.classList.toggle("hidden", isLogin);
          forgotForm.classList.add("hidden");
          resetForm.classList.add("hidden");
          clearStatuses();
        }

        function showForgot() {
          loginForm.classList.add("hidden");
          registerForm.classList.add("hidden");
          resetForm.classList.add("hidden");
          forgotForm.classList.remove("hidden");
          tabLogin.classList.remove("active");
          tabRegister.classList.remove("active");
          clearStatuses();
        }

        function showReset() {
          loginForm.classList.add("hidden");
          registerForm.classList.add("hidden");
          forgotForm.classList.add("hidden");
          resetForm.classList.remove("hidden");
          tabLogin.classList.remove("active");
          tabRegister.classList.remove("active");
          clearStatuses();
        }

        function clearStatuses() {
          for (const el of [loginStatus, registerStatus, forgotStatus, resetStatus, gameStatus]) {
            el.textContent = "";
            el.className = "status";
          }
        }

        function setStatus(el, type, msg) {
          el.textContent = msg;
          el.className = `status ${type}`;
        }

        function setSignedInUI(user) {
          userEmailEl.textContent = user?.email ?? "Non connecté";
          logoutBtn.classList.toggle("hidden", !user);
          gamePanel.classList.toggle("hidden", !user);
          authPanel.classList.toggle("hidden", !!user);
        }

        tabLogin.addEventListener("click", () => setActiveTab("login"));
        tabRegister.addEventListener("click", () => setActiveTab("register"));
        forgotBtn.addEventListener("click", showForgot);
        backToLoginBtn.addEventListener("click", () => setActiveTab("login"));
        cancelResetBtn.addEventListener("click", () => setActiveTab("login"));

        logoutBtn.addEventListener("click", async () => {
          clearStatuses();
          const { error } = await supabase.auth.signOut();
          if (error) setStatus(loginStatus, "error", error.message);
        });

        loginForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          clearStatuses();
          setStatus(loginStatus, "warn", "Connexion en cours...");
          const email = loginEmail.value.trim();
          const password = loginPassword.value;
          const { data, error } = await supabase.auth.signInWithPassword({ email, password });
          if (error) {
            setStatus(loginStatus, "error", error.message);
            return;
          }
          if (data?.session) setStatus(loginStatus, "ok", "Connecté !");
        });

        registerForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          clearStatuses();
          setStatus(registerStatus, "warn", "Création du compte...");
          const email = registerEmail.value.trim();
          const password = registerPassword.value;
          const { data, error } = await supabase.auth.signUp({ email, password });
          if (error) {
            setStatus(registerStatus, "error", error.message);
            return;
          }
          if (data?.user) {
            const needsConfirmation = !data.session;
            if (needsConfirmation) {
              setStatus(registerStatus, "ok", "Compte créé. Vérifiez votre email pour confirmer votre adresse.");
            } else {
              setStatus(registerStatus, "ok", "Compte créé et connecté !");
            }
            setActiveTab("login");
          }
        });

        forgotForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          clearStatuses();
          const email = forgotEmail.value.trim();
          if (!email) {
            setStatus(forgotStatus, "error", "Veuillez saisir votre email.");
            return;
          }
          setStatus(forgotStatus, "warn", "Envoi du lien...");
          const redirectTo = `${location.origin}${location.pathname}`;
          const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo });
          if (error) {
            setStatus(forgotStatus, "error", error.message);
            return;
          }
          setStatus(forgotStatus, "ok", "Lien envoyé. Consultez votre email.");
        });

        resetForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          clearStatuses();
          const newPassword = resetPassword.value;
          if (!newPassword || newPassword.length < 6) {
            setStatus(resetStatus, "error", "Le mot de passe doit contenir au moins 6 caractères.");
            return;
          }
          setStatus(resetStatus, "warn", "Mise à jour du mot de passe...");
          const { data, error } = await supabase.auth.updateUser({ password: newPassword });
          if (error) {
            setStatus(resetStatus, "error", error.message);
            return;
          }
          resetPassword.value = "";
          setStatus(resetStatus, "ok", "Mot de passe mis à jour. Vous pouvez vous reconnecter.");
          setActiveTab("login");
        });

        // ----------------------
        // Lobby en ligne (Supabase)
        // ----------------------
        const TABLE_GAMES = 'eureka_games';
        const TABLE_PLAYERS = 'eureka_game_players';
        let currentRoomCode = null;
        let isHost = false;
        let gamesChannel = null;
        let roomChannel = null;
        let currentUser = null;
        let currentUserName = '';
        let lastGameRow = null;
        let countdownInterval = null;

        const lobby = document.getElementById('lobby');
        const gameCodeInput = document.getElementById('game-code-input');
        const createGameBtn = document.getElementById('create-game');
        const lobbyStatus = document.getElementById('lobby-status');
        const gamesList = document.getElementById('games-list');

        const room = document.getElementById('room');
        const roomCodeEl = document.getElementById('room-code');
        const launchGameBtn = document.getElementById('launch-game');
        const leaveGameBtn = document.getElementById('leave-game');
        const roomStatus = document.getElementById('room-status');

        function showLobbyUI() {
          // Show lobby, hide room and gameplay until a room is started
          lobby.classList.remove('hidden');
          room.classList.add('hidden');
          setupArea.classList.add('hidden');
          playArea.classList.add('hidden');
          nextRoundBtn.classList.add('hidden');
          currentRoomCode = null;
          isHost = false;
          unsubscribeRoom();
        }

        function setLobbyStatus(type, msg) { setStatus(lobbyStatus, type, msg); }
        function setRoomStatus(type, msg) { setStatus(roomStatus, type, msg); }

        async function fetchWaitingGames() {
          const { data, error } = await supabase
            .from(TABLE_GAMES)
            .select('code, host_user_id, status, created_at')
            .eq('status', 'waiting')
            .order('created_at', { ascending: false });
          if (error) { setLobbyStatus('error', error.message); return []; }
          return data || [];
        }

        function renderGames(games) {
          if (!games.length) {
            gamesList.innerHTML = '<div class="muted">Aucune partie en attente.</div>';
            return;
          }
          gamesList.innerHTML = games.map(g => `
            <div class="row">
              <span class="chip">Code: ${g.code}</span>
              <button class="btn secondary join-game" data-code="${g.code}">Rejoindre</button>
            </div>
          `).join('');
          gamesList.querySelectorAll('.join-game').forEach(btn => {
            btn.addEventListener('click', async () => {
              const code = btn.getAttribute('data-code');
              await joinGame(code);
            });
          });
        }

        async function ensureJoinedPlayer(code) {
          const { data: authData } = await supabase.auth.getUser();
          const user = authData?.user;
          if (!user) return;
          const displayName = (user.user_metadata?.name || user.email || 'Joueur').split('@')[0];
          // Try to insert, ignore if exists (policy should prevent duplicates or use unique index)
          await supabase.from(TABLE_PLAYERS).upsert(
            { game_code: code, user_id: user.id, name: displayName, score: 0 },
            { onConflict: 'game_code,user_id' }
          );
        }

        async function createGame() {
          setLobbyStatus('warn', 'Création...');
          const code = (gameCodeInput.value || '').trim();
          if (!/^\d{3,6}$/.test(code)) { setLobbyStatus('error', 'Entrez un numéro (3-6 chiffres).'); return; }
          const { data: authData } = await supabase.auth.getUser();
          const user = authData?.user;
          if (!user) { setLobbyStatus('error', 'Connectez-vous.'); return; }
          // Create game
          const { error } = await supabase.from(TABLE_GAMES).insert({ code, host_user_id: user.id, status: 'waiting', total_rounds: TOTAL_ROUNDS_DEFAULT, current_round: 0, active_letter: null, active_category: null });
          if (error) { setLobbyStatus('error', error.message); return; }
          // Join as player and enter room
          await ensureJoinedPlayer(code);
          isHost = true;
          enterRoom(code);
        }

        async function joinGame(code) {
          setLobbyStatus('warn', `Rejoindre ${code}...`);
          await ensureJoinedPlayer(code);
          isHost = false;
          enterRoom(code);
        }

        function unsubscribeGames() {
          if (gamesChannel) { supabase.removeChannel(gamesChannel); gamesChannel = null; }
        }
        function unsubscribeRoom() {
          if (roomChannel) { supabase.removeChannel(roomChannel); roomChannel = null; }
        }

        async function subscribeGamesList() {
          unsubscribeGames();
          gamesChannel = supabase.channel('games-list')
            .on('postgres_changes', { event: '*', schema: 'public', table: TABLE_GAMES }, async (payload) => {
              const games = await fetchWaitingGames();
              renderGames(games);
            })
            .subscribe();
        }

        let lastTotalScore = 0;

        async function subscribeRoom(code) {
          unsubscribeRoom();
          roomChannel = supabase.channel('room-' + code)
            .on('postgres_changes', { event: '*', schema: 'public', table: TABLE_GAMES, filter: `code=eq.${code}` }, async (payload) => {
              const newRow = payload.new || payload.record;
              if (!newRow) return;
              if (newRow.status === 'started' || newRow.status === 'playing' || newRow.status === 'finished') {
                onGameStateUpdate(newRow);
              }
            })
            .on('broadcast', { event: 'buzz' }, (payload) => {
              // fallback broadcast if needed
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: TABLE_PLAYERS, filter: `game_code=eq.${code}` }, async () => {
              const { data } = await supabase.from(TABLE_PLAYERS).select('*').eq('game_code', code);
              playersInRoom = (data || []).map(r => ({ user_id: r.user_id, name: r.name, score: r.score || 0 }));
              renderBuzzers();
              renderScoreboard();
              // Détection d'un point marqué → avancer automatiquement si hôte
              const total = playersInRoom.reduce((s, p) => s + (p.score || 0), 0);
              if (isHost && total > lastTotalScore && lastGameRow?.status === 'playing') {
                lastTotalScore = total;
                // Nettoyer l'UI de proposition et passer à la manche suivante
                await hostNextRound();
              } else {
                lastTotalScore = total;
              }
            })
            .subscribe();
        }

        async function refreshLobby() {
          const games = await fetchWaitingGames();
          renderGames(games);
        }

        async function enterRoom(code) {
          currentRoomCode = code;
          roomCodeEl.textContent = code;
          lobby.classList.add('hidden');
          room.classList.remove('hidden');
          setupArea.classList.add('hidden');
          playArea.classList.add('hidden');
          nextRoundBtn.classList.add('hidden');
          setLobbyStatus('','');
          setRoomStatus('ok', isHost ? 'Vous êtes l’hôte.' : 'Vous avez rejoint la partie.');
          launchGameBtn.classList.toggle('hidden', !isHost);
          subscribeRoom(code);
          // Charger l'état initial
          const { data: gameRow } = await supabase.from(TABLE_GAMES).select('*').eq('code', code).single();
          onGameStateUpdate(gameRow);
          const { data: plist } = await supabase.from(TABLE_PLAYERS).select('*').eq('game_code', code);
          playersInRoom = (plist || []).map(r => ({ user_id: r.user_id, name: r.name, score: r.score || 0 }));
          renderBuzzers();
          renderScoreboard();
          lastTotalScore = playersInRoom.reduce((s, p) => s + (p.score || 0), 0);
        }

        createGameBtn.addEventListener('click', async (e) => { e.preventDefault(); await createGame(); });
        launchGameBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          if (!isHost || !currentRoomCode) return;
          // passer directement à la première manche synchronisée
          const letter = randomFrom(alphabet);
          const category = randomFrom(categories);
          const { error } = await supabase.from(TABLE_GAMES)
            .update({ status: 'playing', current_round: 1, total_rounds: TOTAL_ROUNDS_DEFAULT, active_letter: letter, active_category: category })
            .eq('code', currentRoomCode);
          if (error) setRoomStatus('error', error.message);
        });
        leaveGameBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          if (!currentRoomCode) { showLobbyUI(); return; }
          const { data: authData } = await supabase.auth.getUser();
          const user = authData?.user;
          if (user) {
            // remove player row
            await supabase.from(TABLE_PLAYERS).delete().eq('game_code', currentRoomCode).eq('user_id', user.id);
            if (isHost) {
              // host deletes the game if still waiting
              await supabase.from(TABLE_GAMES).delete().eq('code', currentRoomCode).eq('status', 'waiting');
            }
          }
          showLobbyUI();
          await refreshLobby();
        });

        async function initLobby() {
          await refreshLobby();
          await subscribeGamesList();
        }

        // ----------------------
        // Jeu Eureka (local)
        // ----------------------
        const categories = [
          "Prénom masculin", "Prénom féminin", "Ville", "Etat, Pays", "Frômage",
          "Fruit ou légume", "Métier", "Couleur", "Film de cinéma", "Sport", "Instrument de musique", 
          "Petit-déjeuner", "Nom ou modèle de voiture", "Chanson", "Habit, vêtement", "Site célèbre dans le monde",
          "Partie du corps humain", "Peuple, tribu, civilisation", "Héros de dessin animé ou de BD", 
          "Expression ou mot composé", "Ammeublement, décoration d'intérieur", "Fleuve, Rivière, Océan", "Parfum", "Dans un sac à main"
          "Journal/ magazine", "Jeu", "Récipient", "Mot qui contient la lettre K", "Homme politique actuel", "Homme ou femme célèbre", 
          "Dans la mythologie", "Arbre", "Ile", "A la montagne", "Mammifère", "Animal aquatique", "Mot se terminant par -elle", 
          "Outil de travail", "Poisson", "Ecrivain", "Piece de viande, charcuterie", "Materiau ou minéral", "Produit de luxe", 
          "Objet qui coupe", "Temps et météo", "Peintre célèbre", "Moyen de transport", "Bataille ou guerre célèbre", "plat cuisiné ou spécialité", 
          "Dans une fête", "En Italie", "Acteur", "Dans une gare ou un aéroport", "A la ferme", "Dans la Bible", "Monument ou lieu célèbre en France", 
          "Chanteur ou groupe", "Région, province", "Série ou émission TV", "Gâteau, bonbons, friandises", "Mot de 5 lettres sans la lettre E", "Oiseau", 
          "Capitale d'Etat", "Pièce d'une voiture", "Fleur", "Mot de 8 lettres", "Boisson", "Appareil électrique", "Sportif célèbre", "Insulte ou gros mot"
                    
        ];
        const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");

        const TOTAL_ROUNDS_DEFAULT = 20;

        // Etat local (multi)
        const players = []; // conservé mais inutilisé pour config locale
        let playersInRoom = [];
        let totalRounds = TOTAL_ROUNDS_DEFAULT;
        let currentRound = 0;
        let activeLetter = "A";
        let activeCategory = categories[0];
        let selectedCategories = new Set(categories); // non utilisé en mode en ligne
        let lockedResponderUserId = null;

        // Setup UI refs
        const playerNameInput = document.getElementById("player-name-input");
        const addPlayerBtn = document.getElementById("add-player");
        const playersList = document.getElementById("players-list");
        const roundsInput = document.getElementById("rounds-input");
        const categoriesList = document.getElementById("categories-list");
        const selectAllCatsBtn = document.getElementById("select-all-cats");
        const clearCatsBtn = document.getElementById("clear-cats");

        const setupArea = document.getElementById("setup");
        const playArea = document.getElementById("play");
        const roundCounter = document.getElementById("round-counter");
        const bigLetter = document.getElementById("big-letter");
        const currentCategoryEl = document.getElementById("current-category");
        const buzzers = document.getElementById("buzzers");
        const responderName = document.getElementById("responder-name");
        const responseArea = document.getElementById("response-area");
        const proposedWord = document.getElementById("proposed-word");
        const validateWordBtn = document.getElementById("validate-word");
        const rejectWordBtn = document.getElementById("reject-word");
        const roundStatus = document.getElementById("round-status");
        const scoreboard = document.getElementById("scoreboard");
        const nextRoundBtn = document.getElementById("next-round");
        const startGameBtn = document.getElementById("start-game");
        const endGameBtn = document.getElementById("end-game");
        const voteArea = document.getElementById('vote-area');
        const voteAcceptBtn = document.getElementById('vote-accept');
        const voteRejectBtn = document.getElementById('vote-reject');

        function renderPlayers() {
          playersList.innerHTML = players.map((p, idx) => `
            <div class="row">
              <span class="chip">${p.name}</span>
              <button data-i="${idx}" class="btn secondary remove-player">Retirer</button>
            </div>
          `).join("");
          playersList.querySelectorAll('.remove-player').forEach(btn => {
            btn.addEventListener('click', (e) => {
              const i = Number(btn.getAttribute('data-i'));
              players.splice(i, 1);
              renderPlayers();
              renderScoreboard();
            });
          });
        }

        function renderCategories() {
          categoriesList.innerHTML = categories.map(cat => {
            const checked = selectedCategories.has(cat) ? 'checked' : '';
            return `<label style="display:flex;align-items:center;gap:8px;margin:6px 0;">
              <input type="checkbox" class="cat-cb" value="${cat}" ${checked} />
              <span>${cat}</span>
            </label>`;
          }).join("");
          categoriesList.querySelectorAll('.cat-cb').forEach(cb => {
            cb.addEventListener('change', () => {
              const v = cb.value;
              if (cb.checked) selectedCategories.add(v); else selectedCategories.delete(v);
            });
          });
        }

        function renderBuzzers() {
          const me = playersInRoom.find(p => String(p.user_id) === String((currentUser||{}).id));
          console.log("DEBUG: renderBuzzers -> me =", me);
          if (!me) {
            buzzers.innerHTML = '<div class="muted">En attente de votre inscription à la partie…</div>';
            return;
          }
          buzzers.innerHTML = `<button class="buzzer-btn" id="my-buzzer" data-user="${me.user_id}">BIP ${me.name}</button>`;
          const myBtn = document.getElementById('my-buzzer');
          myBtn.addEventListener('click', async () => { await tryBuzz(me.user_id); });
        }

        function renderScoreboard() {
          scoreboard.innerHTML = playersInRoom.map((p) => `
            <div class="score-item">
              <span>${p.name}</span>
              <strong>${p.score ?? 0}</strong>
            </div>
          `).join("");
        }

        function randomFrom(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

        function drawLetterAndCategory() {
          activeLetter = randomFrom(alphabet);
          activeCategory = randomFrom(categories);
          bigLetter.textContent = activeLetter;
          currentCategoryEl.textContent = activeCategory;
          roundStatus.textContent = "";
          responseArea.classList.add('hidden');
          lockedResponderUserId = null;
          // enable all buzzers
          buzzers.querySelectorAll('button').forEach(b => b.disabled = false);
        }

        function stopCountdown() {
          if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
          const existing = document.getElementById('countdown');
          if (existing) existing.remove();
        }

        function startCountdown(lockedAtIso, seconds) {
          stopCountdown();
          const counter = document.createElement('div');
          counter.id = 'countdown';
          counter.className = 'chip';
          responseArea.appendChild(counter);
          function tick() {
            const now = Date.now();
            const start = lockedAtIso ? new Date(lockedAtIso).getTime() : now;
            const elapsed = Math.floor((now - start) / 1000);
            const remain = Math.max(0, seconds - elapsed);
            counter.textContent = `Temps restant: ${remain}s`;
            if (remain <= 0) {
              stopCountdown();
              releaseLock();
            }
          }
          tick();
          countdownInterval = setInterval(tick, 250);
        }

        async function tryBuzz(userId) {
          if (!currentRoomCode) return;
          try {
            console.log("DEBUG: tryBuzz called by", userId);
            await supabase.rpc('eureka_try_buzz', { p_code: currentRoomCode, p_user: userId });
          } catch (_) {}
        }

        async function releaseLock() {
          if (!currentRoomCode) return;
          try {
            await supabase.rpc('eureka_release_lock', { p_code: currentRoomCode });
          } catch (_) {}
        }

        function showVoteUI(show) {
          voteArea.classList.toggle('hidden', !show);
        }

        function lockResponder(userId) {
          if (lockedResponderUserId !== null) return; // already locked
          lockedResponderUserId = userId;
          // disable all buzzers
          buzzers.querySelectorAll('button').forEach((b) => b.disabled = b.getAttribute('data-user') !== userId);
          const responder = playersInRoom.find(p => p.user_id === userId);
          responderName.textContent = responder?.name || 'Joueur';
          responseArea.classList.remove('hidden');
          proposedWord.value = "";
          proposedWord.focus();
        }

        async function hostNextRound() {
          if (!isHost || !currentRoomCode) return;
          const { data: g } = await supabase.from(TABLE_GAMES).select('current_round,total_rounds').eq('code', currentRoomCode).single();
          const next = (g?.current_round ?? 0) + 1;
          const total = g?.total_rounds ?? TOTAL_ROUNDS_DEFAULT;
          if (next > total) {
            await supabase.from(TABLE_GAMES).update({ status: 'finished' }).eq('code', currentRoomCode);
            return;
          }
          const letter = randomFrom(alphabet);
          const category = randomFrom(categories);
          await supabase.from(TABLE_GAMES).update({ status: 'playing', current_round: next, total_rounds: total, active_letter: letter, active_category: category, locked_user_id: null, locked_at: null, proposed_word: null }).eq('code', currentRoomCode);
          nextRoundBtn.classList.add('hidden');
        }

        function onGameStateUpdate(row) {
          if (!row) return;
          lastGameRow = row;
          /* */
          console.log("DEBUG: currentUser.id =", currentUser?.id);
          console.log("DEBUG: locked_user_id =", row.locked_user_id);
          console.log("DEBUG: playersInRoom =", playersInRoom);
          /* */
          totalRounds = row.total_rounds ?? TOTAL_ROUNDS_DEFAULT;
          currentRound = row.current_round ?? 0;
          activeLetter = row.active_letter ?? activeLetter;
          activeCategory = row.active_category ?? activeCategory;
          roundCounter.textContent = `Manche ${currentRound} / ${totalRounds}`;
          bigLetter.textContent = activeLetter;
          currentCategoryEl.textContent = activeCategory;
          // Buzz/lock state
          lockedResponderUserId = row.locked_user_id ?? null;
          const locked = lockedResponderUserId !== null && lockedResponderUserId !== undefined;
          const myBtn = document.getElementById('my-buzzer');
          if (myBtn) {
            const myUid = myBtn.getAttribute('data-user');
            myBtn.disabled = !!locked;
          }
          if (locked) {
            const responder = playersInRoom.find(p => String(p.user_id) === String(lockedResponderUserId));
            responderName.textContent = responder?.name || 'Joueur';
            responseArea.classList.remove('hidden');
            startCountdown(row.locked_at, 15);
          } else {
            responseArea.classList.add('hidden');
            stopCountdown();
          }
          // Proposed word + contrôle du rôle
          const hasProposal = !!row.proposed_word;
          proposedWord.value = row.proposed_word || '';
          const isResponder = String(lockedResponderUserId || '') === String((currentUser||{}).id || '');
          // Arrêt chrono dès qu'il y a un vote/proposition
          if (hasProposal) stopCountdown();
          // Configuration des contrôles
          if (!locked) {
            proposedWord.disabled = true;
            validateWordBtn.classList.add('hidden');
            rejectWordBtn.classList.add('hidden');
            showVoteUI(false);
          } else if (locked && !hasProposal) {
            proposedWord.disabled = !isResponder;
            validateWordBtn.classList.toggle('hidden', !isResponder);
            rejectWordBtn.classList.toggle('hidden', !isResponder);
            showVoteUI(false);
          } else if (locked && hasProposal) {
            proposedWord.disabled = true;
            // Le proposeur ne vote pas
            showVoteUI(!isResponder);
            validateWordBtn.classList.add('hidden');
            rejectWordBtn.classList.add('hidden');
          }
          // Show play area when playing
          if (row.status === 'playing') {
            lobby.classList.add('hidden');
            room.classList.add('hidden');
            setupArea.classList.add('hidden');
            playArea.classList.remove('hidden');
          }
          if (row.status === 'finished') {
            setStatus(gameStatus, 'ok', 'Partie terminée');
            playArea.classList.add('hidden');
            lobby.classList.remove('hidden');
          }
        }

        // Actions setup
        addPlayerBtn.addEventListener('click', (e) => {
          e.preventDefault();
          const name = playerNameInput.value.trim();
          if (!name) return;
          players.push({ name, score: 0 });
          playerNameInput.value = "";
          renderPlayers();
          renderScoreboard();
        });
        roundsInput.addEventListener('change', () => {
          const v = Number(roundsInput.value);
          if (!Number.isFinite(v) || v < 1) return;
          roundsToPlay = Math.min(Math.max(v, 1), 50);
        });
        selectAllCatsBtn.addEventListener('click', (e) => { e.preventDefault(); selectedCategories = new Set(categories); renderCategories(); });
        clearCatsBtn.addEventListener('click', (e) => { e.preventDefault(); selectedCategories = new Set(); renderCategories(); });

        // Setup local start button is unused in online mode
        startGameBtn.addEventListener('click', (e) => { e.preventDefault(); });
        endGameBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          if (!isHost || !currentRoomCode) return;
          await supabase.from(TABLE_GAMES).update({ status: 'finished' }).eq('code', currentRoomCode);
        });

        validateWordBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          if (lockedResponderUserId === null) return;
          const word = (proposedWord.value || "").trim();
          if (!word) { setStatus(roundStatus, 'error', 'Entrez un mot.'); return; }
          const startsWith = word[0]?.toUpperCase() === activeLetter;
          if (!startsWith) { setStatus(roundStatus, 'error', `Le mot doit commencer par ${activeLetter}.`); return; }
          // Envoi de la proposition pour vote des autres
          await supabase.from(TABLE_GAMES).update({ proposed_word: word, vote_accepts: 0, vote_rejects: 0 }).eq('code', currentRoomCode);
          setStatus(roundStatus, 'warn', 'Vote en cours…');
          // Les buzzers restent bloqués pendant le vote
        });

        rejectWordBtn.addEventListener('click', (e) => {
          e.preventDefault();
          // Annule la saisie locale (avant envoi)
          if (lockedResponderUserId === null) return;
          proposedWord.value = '';
          setStatus(roundStatus, 'warn', 'Saisie annulée.');
        });

        async function vote(accept) {
          if (!currentRoomCode) return;
          if (!currentUser) return;
          // Pour éviter double vote client: app côté serveur devrait garder trace, ici simplifié
          if (accept) {
            await supabase.rpc('eureka_vote_accept', { p_code: currentRoomCode });
          } else {
            await supabase.rpc('eureka_vote_reject', { p_code: currentRoomCode });
          }
          // Tenter de finaliser selon le nombre de joueurs - 1 (sans le proposeur)
          const votersNeeded = Math.max(1, Math.max(0, playersInRoom.length - 1));
          await supabase.rpc('eureka_vote_finalize', { p_code: currentRoomCode, p_threshold: votersNeeded });
        }
        voteAcceptBtn.addEventListener('click', async (e) => { e.preventDefault(); await vote(true); });
        voteRejectBtn.addEventListener('click', async (e) => { e.preventDefault(); await vote(false); });

        nextRoundBtn.addEventListener('click', async (e) => { e.preventDefault(); await hostNextRound(); });

        // Initial render for setup
        renderPlayers();
        renderCategories();

        function handleHashForRecovery() {
          const hash = window.location.hash || "";
          const params = new URLSearchParams(hash.startsWith("#") ? hash.slice(1) : hash);
          const type = params.get("type");
          if (type === "recovery") {
            showReset();
          }
        }

        async function initAuthUI() {
          const { data: sessionData } = await supabase.auth.getSession();
          setSignedInUI(sessionData.session?.user ?? null);

          handleHashForRecovery();

          supabase.auth.onAuthStateChange((event, session) => {
            if (event === "PASSWORD_RECOVERY") {
              showReset();
            }
            setSignedInUI(session?.user ?? null);
            if (session?.user) {
              currentUser = session.user;
              currentUserName = (currentUser.user_metadata?.name || currentUser.email || 'Joueur').split('@')[0];
              // Une fois connecté, l'utilisateur n'a qu'un choix: créer/rejoindre une partie
              showLobbyUI();
              initLobby();
            } else {
              // Déconnexion: nettoyer et revenir à l'auth
              showLobbyUI();
            }
          });
        }

        initAuthUI();
      });
    </script>
  </body>
</html>




